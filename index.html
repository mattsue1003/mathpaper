import React, { useState, useEffect, useRef } from 'react';
import { Printer, Settings, RefreshCcw, FileText, CheckCircle, Plus, Minus, X, Divide } from 'lucide-react';

const MathGenerator = () => {
  // è¨­å®šç‹€æ…‹
  const [config, setConfig] = useState({
    difficulty: 'easy', // easy, medium, hard
    problemCount: 20,   // æ¯é é¡Œç›®æ•¸
    includeAnswers: true, // æ˜¯å¦åŒ…å«ç­”æ¡ˆé 
    numberOfSets: 1,    // ç”¢ç”Ÿå¹¾ä»½ä¸åŒçš„è©¦å·
    operators: {
      add: true,
      sub: true,
      mul: false,
      div: false
    }
  });

  const [generatedSheets, setGeneratedSheets] = useState([]);
  const printRef = useRef();

  // é›£åº¦è¨­å®šå°æ‡‰è¡¨
  const difficultySettings = {
    easy: { min: 1, max: 20, label: 'ç°¡å–® (20ä»¥å…§åŠ æ¸›)', allowMulDiv: false },
    medium: { min: 10, max: 99, label: 'ä¸­ç­‰ (å…©ä½æ•¸åŠ æ¸›)', allowMulDiv: false },
    hard: { min: 10, max: 999, label: 'æŒ‘æˆ° (ä¸‰ä½æ•¸èˆ‡ä¹˜é™¤)', allowMulDiv: true }
  };

  // äº‚æ•¸ç”¢ç”Ÿå™¨
  const getRandomInt = (min, max) => {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  };

  // ç”¢ç”Ÿå–®ä¸€é¡Œç›®
  const generateProblem = (mode) => {
    let num1, num2, operator, answer, symbol;
    
    // æ±ºå®šé‹ç®—ç¬¦è™Ÿ
    const activeOps = [];
    if (config.operators.add) activeOps.push('add');
    if (config.operators.sub) activeOps.push('sub');
    if (mode === 'hard' && config.operators.mul) activeOps.push('mul');
    if (mode === 'hard' && config.operators.div) activeOps.push('div');

    // å¦‚æœæ²’æœ‰é¸ä»»ä½•é‹ç®—ç¬¦è™Ÿï¼Œé è¨­ç‚ºåŠ æ³•
    const op = activeOps.length > 0 
      ? activeOps[getRandomInt(0, activeOps.length - 1)] 
      : 'add';

    const range = difficultySettings[mode];

    switch (op) {
      case 'add':
        symbol = '+';
        num1 = getRandomInt(range.min, range.max);
        num2 = getRandomInt(range.min, range.max);
        answer = num1 + num2;
        break;
      case 'sub':
        symbol = '-';
        num1 = getRandomInt(range.min, range.max);
        num2 = getRandomInt(range.min, num1); // ç¢ºä¿ä¸å‡ºç¾è² æ•¸
        answer = num1 - num2;
        break;
      case 'mul':
        symbol = 'Ã—';
        // ä¹˜æ³•ç‚ºäº†é¿å…æ•¸å­—å¤ªå¤§ï¼Œæˆ‘å€‘é™åˆ¶ä¹˜æ•¸è¼ƒå°
        num1 = getRandomInt(2, 20); 
        num2 = getRandomInt(2, 9);
        answer = num1 * num2;
        break;
      case 'div':
        symbol = 'Ã·';
        // é™¤æ³•é‚è¼¯ï¼šå…ˆæ±ºå®šç­”æ¡ˆå’Œé™¤æ•¸ï¼Œåæ¨è¢«é™¤æ•¸ï¼Œç¢ºä¿æ•´é™¤
        answer = getRandomInt(2, 12);
        num2 = getRandomInt(2, 9);
        num1 = answer * num2;
        break;
      default:
        symbol = '+';
        num1 = 1; num2 = 1; answer = 2;
    }

    return { num1, num2, symbol, answer };
  };

  // ç”¢ç”Ÿæ‰€æœ‰è©¦å·
  const generateSheets = () => {
    const newSheets = [];
    
    for (let i = 0; i < config.numberOfSets; i++) {
      const problems = [];
      for (let j = 0; j < config.problemCount; j++) {
        problems.push(generateProblem(config.difficulty));
      }
      
      const sheetId = `S-${Date.now().toString().slice(-4)}-${i+1}`;
      newSheets.push({
        id: sheetId,
        index: i + 1,
        problems: problems,
        date: new Date().toLocaleDateString('zh-TW')
      });
    }
    setGeneratedSheets(newSheets);
  };

  // åˆå§‹è¼‰å…¥æ™‚ç”¢ç”Ÿä¸€æ¬¡
  useEffect(() => {
    generateSheets();
  }, []);

  // è™•ç†åˆ—å°
  const handlePrint = () => {
    window.print();
  };

  // é›£åº¦è®Šæ›´è™•ç†
  const handleDifficultyChange = (e) => {
    const diff = e.target.value;
    setConfig(prev => ({
      ...prev,
      difficulty: diff,
      // å¦‚æœåˆ‡æ›åˆ°é hardï¼Œå¼·åˆ¶é—œé–‰ä¹˜é™¤
      operators: {
        ...prev.operators,
        mul: diff === 'hard' ? prev.operators.mul : false,
        div: diff === 'hard' ? prev.operators.div : false,
      }
    }));
  };

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
      {/* --- æ§åˆ¶é¢æ¿ (åˆ—å°æ™‚éš±è—) --- */}
      <div className="print:hidden bg-white shadow-md p-6 sticky top-0 z-10">
        <div className="max-w-6xl mx-auto">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <h1 className="text-2xl font-bold text-blue-600 flex items-center gap-2">
              <FileText className="w-8 h-8" />
              æ¨‚é½¡è…¦åŠ›æ¿€ç›ª - æ•¸å­¸é¡Œç›®ç”¢ç”Ÿå™¨
            </h1>
            <button 
              onClick={handlePrint}
              className="mt-4 md:mt-0 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg transition-all"
            >
              <Printer className="w-5 h-5" />
              åˆ—å°é¡Œç›® (A4)
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
            {/* é›£åº¦è¨­å®š */}
            <div className="space-y-2">
              <label className="text-sm font-semibold text-gray-600 flex items-center gap-1">
                <Settings className="w-4 h-4" /> é›£åº¦é¸æ“‡
              </label>
              <select 
                value={config.difficulty}
                onChange={handleDifficultyChange}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="easy">ç°¡å–® (20ä»¥å…§åŠ æ¸›)</option>
                <option value="medium">ä¸­ç­‰ (å…©ä½æ•¸åŠ æ¸›)</option>
                <option value="hard">æŒ‘æˆ° (å«ä¹˜é™¤æ³•)</option>
              </select>
            </div>

            {/* é¡Œå‹é¸æ“‡ */}
            <div className="space-y-2">
              <label className="text-sm font-semibold text-gray-600">é‹ç®—ç¬¦è™Ÿ</label>
              <div className="flex gap-2 flex-wrap">
                <button 
                  onClick={() => setConfig(p => ({...p, operators: {...p.operators, add: !p.operators.add}}))}
                  className={`px-3 py-1 rounded border ${config.operators.add ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-400'}`}
                >ï¼‹</button>
                <button 
                  onClick={() => setConfig(p => ({...p, operators: {...p.operators, sub: !p.operators.sub}}))}
                  className={`px-3 py-1 rounded border ${config.operators.sub ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-400'}`}
                >ï¼</button>
                {config.difficulty === 'hard' && (
                  <>
                    <button 
                      onClick={() => setConfig(p => ({...p, operators: {...p.operators, mul: !p.operators.mul}}))}
                      className={`px-3 py-1 rounded border ${config.operators.mul ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-400'}`}
                    >Ã—</button>
                    <button 
                      onClick={() => setConfig(p => ({...p, operators: {...p.operators, div: !p.operators.div}}))}
                      className={`px-3 py-1 rounded border ${config.operators.div ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-400'}`}
                    >Ã·</button>
                  </>
                )}
              </div>
            </div>

            {/* ç”¢ç”Ÿè¨­å®š */}
            <div className="space-y-2">
              <label className="text-sm font-semibold text-gray-600">ç”¢ç”Ÿä»½æ•¸ (ä¸åŒé¡Œç›®)</label>
              <input 
                type="number" 
                min="1" 
                max="20"
                value={config.numberOfSets}
                onChange={(e) => setConfig({...config, numberOfSets: parseInt(e.target.value) || 1})}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>

            {/* å…¶ä»–é¸é … */}
            <div className="space-y-2 flex flex-col justify-end">
              <label className="flex items-center gap-2 cursor-pointer select-none">
                <input 
                  type="checkbox"
                  checked={config.includeAnswers}
                  onChange={(e) => setConfig({...config, includeAnswers: e.target.checked})}
                  className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                />
                <span className="text-gray-700">ç”¢ç”Ÿç­”æ¡ˆé </span>
              </label>
              
              <button 
                onClick={generateSheets}
                className="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-semibold flex items-center justify-center gap-2 shadow transition-colors"
              >
                <RefreshCcw className="w-4 h-4" /> é‡æ–°ç”¢ç”Ÿé¡Œç›®
              </button>
            </div>
          </div>
          <p className="mt-4 text-sm text-gray-500 bg-blue-50 p-2 rounded inline-block">
            ğŸ’¡ æç¤ºï¼šä½¿ç”¨é›»è…¦ç€è¦½å™¨æŒ‰ä¸‹ã€Œåˆ—å°ã€æˆ– Ctrl+P å³å¯ç²å¾—æœ€ä½³ A4 æ•ˆæœã€‚
          </p>
        </div>
      </div>

      {/* --- åˆ—å°å€åŸŸ --- */}
      <div id="printable-area" className="p-8 mx-auto max-w-[210mm] print:p-0 print:max-w-none">
        
        {/* éæ­·æ¯ä¸€ä»½è©¦å· */}
        {generatedSheets.map((sheet, sIndex) => (
          <React.Fragment key={sheet.id}>
            
            {/* é¡Œç›®å· */}
            <div className="bg-white shadow-xl print:shadow-none p-10 min-h-[297mm] mb-8 print:mb-0 relative print:break-after-page mx-auto w-full box-border">
              {/* é é¦– */}
              <div className="border-b-2 border-gray-800 pb-4 mb-8 flex justify-between items-end">
                <div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">æ¯æ—¥è…¦åŠ›é«”æ“</h2>
                  <p className="text-lg text-gray-600">é›£åº¦ï¼š{difficultySettings[config.difficulty].label.split(' ')[0]} | è©¦å·ç·¨è™Ÿï¼š{sheet.id}</p>
                </div>
                <div className="text-right">
                  <div className="text-xl mb-1">å§“åï¼š________________</div>
                  <div className="text-lg text-gray-500">æ—¥æœŸï¼š{sheet.date} | åˆ†æ•¸ï¼š________</div>
                </div>
              </div>

              {/* é¡Œç›®ç¶²æ ¼ */}
              <div className="grid grid-cols-2 gap-x-12 gap-y-12">
                {sheet.problems.map((prob, pIndex) => (
                  <div key={pIndex} className="flex items-center text-3xl font-mono border-b border-gray-300 pb-2">
                    <span className="w-8 text-gray-400 text-xl font-sans mr-2">{pIndex + 1}.</span>
                    <div className="flex-1 flex justify-between items-center px-4 font-semibold text-gray-800">
                      <span className="w-16 text-right">{prob.num1}</span>
                      <span className="mx-4">{prob.symbol}</span>
                      <span className="w-16 text-left">{prob.num2}</span>
                      <span className="mx-2">=</span>
                      <span className="flex-1"></span> {/* ç©ºç™½è®“é•·è¼©å¡«å¯« */}
                    </div>
                  </div>
                ))}
              </div>

              {/* é å°¾ */}
              <div className="absolute bottom-10 left-0 w-full text-center text-gray-400 text-sm">
                ä¿æŒå¿ƒæƒ…æ„‰å¿«ï¼Œå‹•å‹•è…¦æ›´æœ‰æ´»åŠ›ï¼ | ç¬¬ {sIndex + 1} ä»½ï¼Œå…± {config.numberOfSets} ä»½
              </div>
            </div>

            {/* ç­”æ¡ˆå· (å¦‚æœæœ‰çš„è©±) */}
            {config.includeAnswers && (
              <div className="bg-white shadow-xl print:shadow-none p-10 min-h-[297mm] mb-8 print:mb-0 relative print:break-after-page mx-auto w-full box-border">
                {/* ç­”æ¡ˆå·é é¦– */}
                <div className="border-b-2 border-gray-400 pb-2 mb-6 flex justify-between items-end">
                  <h2 className="text-2xl font-bold text-gray-700">åƒè€ƒè§£ç­”</h2>
                  <p className="text-gray-500">è©¦å·ç·¨è™Ÿï¼š{sheet.id}</p>
                </div>

                {/* ç­”æ¡ˆç¶²æ ¼ (æ¯”è¼ƒå¯†é›†) */}
                <div className="grid grid-cols-4 gap-6">
                  {sheet.problems.map((prob, pIndex) => (
                    <div key={pIndex} className="border border-gray-200 p-3 rounded bg-gray-50 flex flex-col items-center">
                      <span className="text-xs text-gray-400 mb-1">ç¬¬ {pIndex + 1} é¡Œ</span>
                      <div className="text-lg font-mono text-gray-600">
                        {prob.num1} {prob.symbol} {prob.num2}
                      </div>
                      <div className="text-2xl font-bold text-red-600 mt-1">
                        = {prob.answer}
                      </div>
                    </div>
                  ))}
                </div>
                 <div className="absolute bottom-10 left-0 w-full text-center text-gray-400 text-sm">
                  è§£ç­”é  - è«‹åœ¨å®Œæˆå¾Œå†æ ¸å°å“¦ï¼
                </div>
              </div>
            )}

          </React.Fragment>
        ))}
      </div>

      <style>{`
        @media print {
          @page {
            size: A4;
            margin: 10mm;
          }
          body {
            background: white;
            color: black;
          }
        }
      `}</style>
    </div>
  );
};

export default MathGenerator;
