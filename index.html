<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚é½¡å¤§è…¦é«”æ“ - é¡Œç›®ç”¢ç”Ÿå™¨ Pro (20é¡Œç‰ˆ)</title>
    
    <!-- æ”¹ç”¨ html2canvas å’Œ jsPDF ç¨ç«‹å‡½å¼åº«ï¼Œå¯¦ç¾ã€Œå…ˆè½‰åœ–ã€å†è½‰PDFã€çš„ç©©å®šæµç¨‹ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
            color: #333;
        }
        
        /* --- æ§åˆ¶é¢æ¿ (åˆ—å°æ™‚æœƒéš±è—) --- */
        .controls {
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 900px; 
            margin: 0 auto 30px auto; 
            border-left: 10px solid #27ae60;
        }
        
        .controls h2 { 
            margin-top: 0; 
            color: #2c3e50; 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 5px;
        }

        .designer-info {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #555;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .designer-info a {
            color: #27ae60;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .designer-info a:hover {
            color: #219150;
            text-decoration: underline;
        }

        .control-grid { 
            display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        }
        
        .control-group { display: flex; flex-direction: column; }
        
        label { font-weight: bold; margin-bottom: 8px; color: #555; font-size: 0.95rem; }
        
        input, select { 
            padding: 10px; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 16px; background-color: #fff;
        }
        
        input[type="range"] { padding: 0; }
        
        input:focus, select:focus {
            outline: none; border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }
        
        .btn-group { grid-column: 1 / -1; display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        
        button {
            flex: 1; min-width: 200px; padding: 15px; border: none; border-radius: 8px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .gen-btn { background: #27ae60; color: white; box-shadow: 0 4px 0 #219150; }
        .gen-btn:hover { background: #2ecc71; }
        
        .print-btn { background: #34495e; color: white; box-shadow: 0 4px 0 #2c3e50; }
        .print-btn:hover { background: #4b6584; }

        /* æ–°å¢çš„æ‰‹æ©Ÿä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ */
        .pdf-btn { background: #e67e22; color: white; box-shadow: 0 4px 0 #d35400; }
        .pdf-btn:hover { background: #f39c12; }

        /* --- A4 ç´™å¼µé è¦½æ¨£å¼ --- */
        .page-container { 
            width: 210mm; 
            margin: 0 auto; 
            /* è®“æ‰‹æ©Ÿé è¦½æ™‚å¯ä»¥å·¦å³æ»‘å‹•ï¼Œä½†ä¸å½±éŸ¿åˆ—å° */
            overflow-x: auto;
        }
        
        .sheet {
            background: white; 
            width: 210mm; 
            height: 297mm; 
            padding: 15mm 20mm; 
            box-sizing: border-box;
            margin-bottom: 30px; /* è¢å¹•é è¦½æ™‚çš„é–“è· */
            box-shadow: 0 0 15px rgba(0,0,0,0.15); 
            display: flex; 
            flex-direction: column; 
            position: relative;
            overflow: hidden; 
            /* ç¢ºä¿æœ€å°å¯¬åº¦ï¼Œé˜²æ­¢æ‰‹æ©Ÿé è¦½æ™‚å…§å®¹æ“ å£“ */
            min-width: 210mm; 
            /* ç¢ºä¿èƒŒæ™¯è‰²æ˜¯ç™½è‰²ï¼Œè½‰åœ–æ‰ä¸æœƒè®Šé€æ˜ */
            background-color: #ffffff;
        }

        /* Logo æ¨£å¼ */
        .sheet-logo {
            position: absolute;
            top: 15mm;
            left: 15mm;
            z-index: 10; 
            max-width: 300px; 
            object-fit: contain;
        }
        
        /* è€ƒå·é ­éƒ¨ */
        .sheet-header { 
            padding-bottom: 5px; 
            margin-bottom: 10px; 
            position: relative;
            z-index: 1; 
        }
        
        .sheet-title { 
            text-align: center;
            font-size: 26pt; 
            font-weight: 900; 
            letter-spacing: 2px; 
            color: #000; 
            margin-bottom: 20px;
        }
        
        .sheet-info { 
            font-size: 14pt; 
            font-weight: bold; 
            color: #333;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid #333; 
            padding-bottom: 8px;
        }

        .info-right {
            display: flex;
            gap: 20px;
        }
        
        /* é¡Œç›®å€åŸŸç¶²æ ¼ */
        .problem-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            column-gap: 40px; 
            align-content: space-between; 
            flex-grow: 1;
            margin-top: 15px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .problem-item {
            font-weight: bold; 
            border-bottom: 1px dashed #ddd; 
            padding: 5px 0; 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            white-space: nowrap;
        }
        
        /* æ•¸å­—èˆ‡ç¬¦è™Ÿå„ªåŒ– */
        .num { display: inline-block; min-width: 1.5ch; text-align: right; }
        .operator { margin: 0 8px; color: #555; }
        
        /* ä½œç­”æ–¹æ ¼ */
        .answer-box {
            display: inline-flex; 
            align-items: center; justify-content: center;
            width: 70px; height: 45px; 
            border: 2px solid #333; border-radius: 6px;
            margin: 0 8px; vertical-align: middle;
            background: #fff; color: #333;
            position: relative; top: -2px;
        }
        
        .answer-filled {
            color: #d32f2f; font-weight: bold; 
            border-color: #d32f2f; background-color: #fff5f5;
        }

        /* é å°¾ */
        .sheet-footer { 
            text-align: right; 
            font-size: 10pt; 
            color: #888; 
            margin-top: auto; 
            padding-top: 5px;
            position: relative;
            z-index: 1;
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ --- */
        @media print {
            @page { margin: 0; size: A4 portrait; } 
            body { background: white; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .controls { display: none; }
            .sheet { box-shadow: none; margin: 0; page-break-after: always; height: 297mm; width: 210mm; break-inside: avoid; }
            .page-container { width: 100%; margin: 0; overflow: visible; }
            .answer-box { border: 2px solid #333 !important; }
            .answer-filled { border-color: #d32f2f !important; color: #d32f2f !important; }
            .sheet-logo { display: block !important; } 
        }
    </style>
</head>
<body>

<div class="controls no-print">
    <h2>ğŸ§® æ¨‚é½¡å¤§è…¦é«”æ“ - é¡Œç›®ç”¢ç”Ÿå™¨ Pro (20é¡Œç‰ˆ)</h2>
    <div class="designer-info">
        è¨­è¨ˆè€…ï¼š<a href="https://www.facebook.com/chungmenghsiu" target="_blank">é¾å­Ÿä¿® è·èƒ½æ²»ç™‚å¸«</a>
    </div>

    <div class="control-grid">
        <div class="control-group">
            <label>ğŸ“ é¡Œç›®å·æ¨™é¡Œ</label>
            <input type="text" id="titleInput" value="å¤§è…¦ä¿å¥å®¤ - æ•¸å­¸æŒ‘æˆ°">
        </div>

        <div class="control-group">
            <label>ğŸ–¼ï¸ ä¸Šå‚³ Logo (å·¦ä¸Šè§’)</label>
            <input type="file" id="logoInput" accept="image/*">
        </div>

        <div class="control-group">
            <label>ğŸ“ Logo å¤§å°èª¿æ•´</label>
            <input type="range" id="logoSize" min="30" max="250" value="80" oninput="updateLogoSize()">
        </div>
        
        <div class="control-group">
            <label>ğŸ“Š é›£åº¦è¨­å®š</label>
            <select id="difficulty">
                <option value="easy">ç°¡å–® (20ä»¥å…§ï¼Œå­—å¤§)</option>
                <option value="medium">ä¸­ç­‰ (å…©ä½æ•¸ï¼Œå­—ä¸­)</option>
                <option value="hard">æŒ‘æˆ° (ç™¾ä½æ•¸/ä¹˜æ³•)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>â•â– é‹ç®—ç¬¦è™Ÿ</label>
            <select id="opType">
                <option value="mixed">æ··åˆ (åŠ ã€æ¸›)</option>
                <option value="add">åªç·´åŠ æ³• (+)</option>
                <option value="sub">åªç·´æ¸›æ³• (-)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>ğŸ§  é¡Œå‹æ¨¡å¼ (èªçŸ¥è¨“ç·´)</label>
            <select id="problemMode">
                <option value="normal">æ¨™æº–è¨ˆç®— (3 + 5 = â–¡)</option>
                <option value="fill">é‚è¼¯å¡«ç©º (3 + â–¡ = 8)</option>
                <option value="mix_mode">æ··åˆæ¨¡å¼ (æ¨™æº– + å¡«ç©º)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>ğŸ“„ ä»½æ•¸ (é )</label>
            <input type="number" id="pageCount" value="1" min="1" max="20">
        </div>
        
        <div class="control-group">
            <label>ğŸ‘€ è§£ç­”ä½ç½®</label>
            <select id="answerMode">
                <option value="next">æ¯é é¡Œç›®å¾Œç·Šæ¥è§£ç­”</option>
                <option value="end">å…¨éƒ¨æœ€å¾Œå½™æ•´è§£ç­”</option>
                <option value="none">ä¸ç”¢ç”Ÿè§£ç­”</option>
            </select>
        </div>
    </div>
    
    <div class="btn-group">
        <button class="gen-btn" onclick="generateSheets()">âœ¨ é‡æ–°ç”Ÿæˆé¡Œç›®</button>
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / é›»è…¦å­˜ PDF</button>
        <button class="pdf-btn" id="pdfBtn" onclick="downloadPDF()">ğŸ“± ä¸‹è¼‰ PDF (æ‰‹æ©Ÿå®Œç¾ç‰ˆ)</button>
    </div>
</div>

<div class="page-container" id="outputArea">
    <!-- ç”¢å‡ºå…§å®¹æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
</div>

<script>
    // å…¨åŸŸè®Šæ•¸å„²å­˜ Logo è³‡æ–™
    let currentLogoData = null;

    // ç›£è½ Logo ä¸Šå‚³
    document.getElementById('logoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                currentLogoData = event.target.result;
                generateSheets(); 
            };
            reader.readAsDataURL(file);
        }
    });

    function updateLogoSize() {
        const size = document.getElementById('logoSize').value;
        const logos = document.querySelectorAll('.sheet-logo');
        logos.forEach(img => {
            img.style.width = size + 'px';
        });
    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function createProblem(difficulty, opType, mode) {
        let n1, n2, ans, symbol;
        let selectedOp = opType;

        if (opType === 'mixed') {
            selectedOp = Math.random() > 0.5 ? 'add' : 'sub';
        }

        if (difficulty === 'hard' && opType === 'mixed' && Math.random() > 0.7) {
            selectedOp = 'mul';
        }

        if (selectedOp === 'mul') {
            n1 = getRandomInt(2, 9);
            n2 = getRandomInt(2, 9);
            ans = n1 * n2;
            symbol = 'Ã—';
        } else if (difficulty === 'easy') {
            if (selectedOp === 'add') {
                n1 = getRandomInt(1, 15);
                n2 = getRandomInt(1, 20 - n1);
                ans = n1 + n2;
                symbol = '+';
            } else {
                n1 = getRandomInt(5, 20);
                n2 = getRandomInt(1, n1);
                ans = n1 - n2;
                symbol = '-';
            }
        } else if (difficulty === 'medium') {
            if (selectedOp === 'add') {
                n1 = getRandomInt(10, 80);
                n2 = getRandomInt(5, 99 - n1);
                ans = n1 + n2;
                symbol = '+';
            } else {
                n1 = getRandomInt(20, 99);
                n2 = getRandomInt(5, n1 - 5);
                ans = n1 - n2;
                symbol = '-';
            }
        } else { // Hard
            if (selectedOp === 'add') {
                n1 = getRandomInt(100, 800);
                n2 = getRandomInt(10, 999 - n1);
                ans = n1 + n2;
                symbol = '+';
            } else {
                n1 = getRandomInt(200, 999);
                n2 = getRandomInt(50, n1 - 10);
                ans = n1 - n2;
                symbol = '-';
            }
        }

        let displayType = 0; 
        if (mode === 'fill') displayType = 1;
        if (mode === 'mix_mode') displayType = Math.random() > 0.6 ? 1 : 0;

        let html = '';
        let answerVal = '';

        if (displayType === 0) {
            html = `<span class="num">${n1}</span> <span class="operator">${symbol}</span> <span class="num">${n2}</span> <span class="operator">=</span> <div class="answer-box"></div>`;
            answerVal = ans;
        } else {
            html = `<span class="num">${n1}</span> <span class="operator">${symbol}</span> <div class="answer-box"></div> <span class="operator">=</span> <span class="num">${ans}</span>`;
            answerVal = n2;
        }

        return { 
            html: html, 
            ans: answerVal, 
            ansHtml: html.replace('answer-box">', `answer-box answer-filled">${answerVal}`) 
        };
    }

    function generateSheets() {
        const title = document.getElementById('titleInput').value;
        const difficulty = document.getElementById('difficulty').value;
        const opType = document.getElementById('opType').value;
        const problemMode = document.getElementById('problemMode').value;
        const pages = parseInt(document.getElementById('pageCount').value);
        const answerMode = document.getElementById('answerMode').value;
        const logoSize = document.getElementById('logoSize').value;
        const container = document.getElementById('outputArea');
        
        container.innerHTML = ''; 
        let allAnswerSheets = [];

        let problemsPerPage = 20; 
        let fontSize = '26pt'; 

        if (difficulty === 'hard') {
            fontSize = '22pt'; 
        }

        for (let i = 1; i <= pages; i++) {
            let problems = [];
            for (let k = 0; k < problemsPerPage; k++) {
                problems.push(createProblem(difficulty, opType, problemMode));
            }

            container.appendChild(createSheetHTML(title, i, pages, problems, false, fontSize, logoSize));

            if (answerMode !== 'none') {
                let ansSheet = createSheetHTML(title + " (è§£ç­”)", i, pages, problems, true, fontSize, logoSize);
                if (answerMode === 'next') container.appendChild(ansSheet);
                else allAnswerSheets.push(ansSheet);
            }
        }

        if (answerMode === 'end') {
            allAnswerSheets.forEach(s => container.appendChild(s));
        }
    }

    function createSheetHTML(title, pageNum, totalPages, problems, isAnswer, fontSize, logoSize) {
        const div = document.createElement('div');
        div.className = 'sheet';
        
        let logoHtml = '';
        if (currentLogoData) {
            logoHtml = `<img src="${currentLogoData}" class="sheet-logo" style="width: ${logoSize}px" alt="Logo">`;
        }

        let gridHtml = '';
        problems.forEach(p => {
            gridHtml += `
                <div class="problem-item" style="font-size: ${fontSize}">
                    ${isAnswer ? p.ansHtml : p.html}
                </div>
            `;
        });

        div.innerHTML = `
            ${logoHtml}
            <div class="sheet-header">
                <div class="sheet-title">${title}</div>
                <div class="sheet-info">
                    <span class="info-left">å§“åï¼š____________</span>
                    <span class="info-right">
                        <span>æ—¥æœŸï¼š____ / ____ / ____</span>
                        <span>åˆ†æ•¸ï¼š______</span>
                    </span>
                </div>
            </div>
            <div class="problem-grid">
                ${gridHtml}
            </div>
            <div class="sheet-footer">
                ç¬¬ ${pageNum} é 
            </div>
        `;
        return div;
    }

    // --- çµ‚æ¥µä¿®æ­£ç‰ˆï¼šåœ–ç‰‡åˆæˆ PDF æ³• ---
    // ä¾åºå°‡æ¯ä¸€é ã€Œæ‹ç…§ã€æˆåœ–ç‰‡ï¼Œå†è²¼åˆ° PDF ä¸Šï¼Œå¯¦ç¾ 100% æ‰€è¦‹å³æ‰€å¾—
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        const title = document.getElementById('titleInput').value;
        const sheets = document.querySelectorAll('.sheet');
        
        btn.disabled = true;

        try {
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;

            for (let i = 0; i < sheets.length; i++) {
                // æ›´æ–°æŒ‰éˆ•é€²åº¦
                btn.innerText = `â³ è™•ç†ç¬¬ ${i + 1} / ${sheets.length} é ...`;

                const sheet = sheets[i];

                // 1. è¤‡è£½ç¯€é»åˆ°å›ºå®šå®¹å™¨ï¼Œå¼·åˆ¶æ¡Œé¢å¯¬åº¦ (1600px)
                // é€™æ¨£ html2canvas å°±æœƒèªç‚ºæ˜¯åœ¨å¤§è¢å¹•ä¸Šæ¸²æŸ“
                const clone = sheet.cloneNode(true);
                clone.style.width = '210mm';
                clone.style.height = '297mm';
                clone.style.position = 'fixed';
                clone.style.top = '0';
                clone.style.left = '0';
                clone.style.zIndex = '-9999';
                clone.style.margin = '0';
                clone.style.transform = 'none'; // ç§»é™¤ä»»ä½•ç¸®æ”¾
                
                document.body.appendChild(clone);

                // 2. ä½¿ç”¨ html2canvas æˆªåœ–
                // windowWidth: 1600 æ˜¯é—œéµï¼Œæ¬ºé¨™ç€è¦½å™¨é€™æ˜¯æ¡Œé¢ç‰ˆ
                const canvas = await html2canvas(clone, {
                    scale: 2, // 2å€è§£æåº¦ï¼Œç¢ºä¿æ¸…æ™°
                    useCORS: true,
                    windowWidth: 1600, 
                    width: 794, // A4 åœ¨ 96DPI ä¸‹ç´„ 794px
                    height: 1123,
                    scrollY: 0,
                    scrollX: 0
                });

                // 3. ç§»é™¤è¤‡è£½ç¯€é»
                document.body.removeChild(clone);

                // 4. å°‡ Canvas è½‰ç‚ºåœ–ç‰‡æ•¸æ“š
                const imgData = canvas.toDataURL('image/jpeg', 0.95);

                // 5. å°‡åœ–ç‰‡è²¼åˆ° PDF
                if (i > 0) {
                    pdf.addPage();
                }
                pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
            }

            // 6. å­˜æª”
            btn.innerText = "ğŸ’¾ æ­£åœ¨å„²å­˜...";
            pdf.save(title + '.pdf');

        } catch (err) {
            console.error(err);
            alert("è½‰æª”å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é å¾Œå†è©¦ä¸€æ¬¡ï¼Œæˆ–æ”¹ç”¨é›»è…¦æ“ä½œã€‚");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    window.onload = generateSheets;
</script>

</body>
</html>
