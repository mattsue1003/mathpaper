<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚é½¡å¤§è…¦é«”æ“ - é¡Œç›®ç”¢ç”Ÿå™¨ Pro (20é¡Œç‰ˆ)</title>
    
    <!-- å¼•å…¥ html2pdf å‡½å¼åº«ï¼Œç”¨æ–¼ç›´æ¥ä¸‹è¼‰ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
            color: #333;
        }
        
        /* --- æ§åˆ¶é¢æ¿ (åˆ—å°æ™‚æœƒéš±è—) --- */
        .controls {
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 900px; 
            margin: 0 auto 30px auto; 
            border-left: 10px solid #27ae60;
        }
        
        .controls h2 { 
            margin-top: 0; 
            color: #2c3e50; 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 5px;
        }

        .designer-info {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #555;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .designer-info a {
            color: #27ae60;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .designer-info a:hover {
            color: #219150;
            text-decoration: underline;
        }

        .control-grid { 
            display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        }
        
        .control-group { display: flex; flex-direction: column; }
        
        label { font-weight: bold; margin-bottom: 8px; color: #555; font-size: 0.95rem; }
        
        input, select { 
            padding: 10px; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 16px; background-color: #fff;
        }
        
        input[type="range"] { padding: 0; }
        
        input:focus, select:focus {
            outline: none; border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }
        
        .btn-group { grid-column: 1 / -1; display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        
        button {
            flex: 1; min-width: 200px; padding: 15px; border: none; border-radius: 8px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .gen-btn { background: #27ae60; color: white; box-shadow: 0 4px 0 #219150; }
        .gen-btn:hover { background: #2ecc71; }
        
        .print-btn { background: #34495e; color: white; box-shadow: 0 4px 0 #2c3e50; }
        .print-btn:hover { background: #4b6584; }

        /* æ–°å¢çš„æ‰‹æ©Ÿä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ */
        .pdf-btn { background: #e67e22; color: white; box-shadow: 0 4px 0 #d35400; }
        .pdf-btn:hover { background: #f39c12; }

        /* --- A4 ç´™å¼µé è¦½æ¨£å¼ --- */
        .page-container { width: 210mm; margin: 0 auto; }
        
        .sheet {
            background: white; 
            width: 210mm; 
            height: 297mm; 
            padding: 15mm 20mm; 
            box-sizing: border-box;
            margin-bottom: 30px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.15); 
            display: flex; 
            flex-direction: column; 
            position: relative; /* è®“çµ•å°å®šä½çš„ Logo åƒè€ƒæ­¤å®¹å™¨ */
            overflow: hidden; /* é¿å… Logo è¶…å‡ºç´™å¼µ */
        }

        /* å°ˆé–€ç‚ºäº† html2pdf ç”Ÿæˆæ™‚ä½¿ç”¨çš„æ¨£å¼ï¼Œæ¶ˆé™¤é™°å½±å’Œé–“è· */
        body.generating-pdf .sheet {
            box-shadow: none;
            margin-bottom: 0;
            margin-top: 0;
        }

        /* Logo æ¨£å¼ */
        .sheet-logo {
            position: absolute;
            top: 15mm;
            left: 15mm;
            z-index: 10; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            max-width: 300px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ä»¥å…å¤±æ§ */
            object-fit: contain;
        }
        
        /* è€ƒå·é ­éƒ¨ */
        .sheet-header { 
            padding-bottom: 5px; 
            margin-bottom: 10px; 
            position: relative;
            z-index: 1; /* å…§å®¹å±¤ç´š */
        }
        
        .sheet-title { 
            text-align: center;
            font-size: 26pt; 
            font-weight: 900; 
            letter-spacing: 2px; 
            color: #000; 
            margin-bottom: 20px;
        }
        
        .sheet-info { 
            font-size: 14pt; 
            font-weight: bold; 
            color: #333;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid #333; 
            padding-bottom: 8px;
        }

        .info-right {
            display: flex;
            gap: 20px;
        }
        
        /* é¡Œç›®å€åŸŸç¶²æ ¼ */
        .problem-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            column-gap: 40px; 
            align-content: space-between; 
            flex-grow: 1;
            margin-top: 15px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .problem-item {
            font-weight: bold; 
            border-bottom: 1px dashed #ddd; 
            padding: 5px 0; 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            white-space: nowrap;
        }
        
        /* æ•¸å­—èˆ‡ç¬¦è™Ÿå„ªåŒ– */
        .num { display: inline-block; min-width: 1.5ch; text-align: right; }
        .operator { margin: 0 8px; color: #555; }
        
        /* ä½œç­”æ–¹æ ¼ */
        .answer-box {
            display: inline-flex; 
            align-items: center; justify-content: center;
            width: 70px; height: 45px; 
            border: 2px solid #333; border-radius: 6px;
            margin: 0 8px; vertical-align: middle;
            background: #fff; color: #333;
            position: relative; top: -2px;
        }
        
        .answer-filled {
            color: #d32f2f; font-weight: bold; 
            border-color: #d32f2f; background-color: #fff5f5;
        }

        /* é å°¾ */
        .sheet-footer { 
            text-align: right; 
            font-size: 10pt; 
            color: #888; 
            margin-top: auto; 
            padding-top: 5px;
            position: relative;
            z-index: 1;
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ --- */
        @media print {
            @page { margin: 0; size: A4 portrait; } 
            body { background: white; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .controls { display: none; }
            .sheet { box-shadow: none; margin: 0; page-break-after: always; height: 297mm; width: 210mm; break-inside: avoid; }
            .page-container { width: 100%; margin: 0; }
            .answer-box { border: 2px solid #333 !important; }
            .answer-filled { border-color: #d32f2f !important; color: #d32f2f !important; }
            /* ç¢ºä¿åˆ—å°æ™‚ Logo æœƒå‡ºç¾ */
            .sheet-logo { display: block !important; } 
        }
    </style>
</head>
<body>

<div class="controls no-print">
    <h2>ğŸ§® æ¨‚é½¡å¤§è…¦é«”æ“ - é¡Œç›®ç”¢ç”Ÿå™¨ Pro (20é¡Œç‰ˆ)</h2>
    <div class="designer-info">
        è¨­è¨ˆè€…ï¼š<a href="https://www.facebook.com/chungmenghsiu" target="_blank">é¾å­Ÿä¿® è·èƒ½æ²»ç™‚å¸«</a>
    </div>

    <div class="control-grid">
        <div class="control-group">
            <label>ğŸ“ é¡Œç›®å·æ¨™é¡Œ</label>
            <input type="text" id="titleInput" value="å¤§è…¦ä¿å¥å®¤ - æ•¸å­¸æŒ‘æˆ°">
        </div>

        <div class="control-group">
            <label>ğŸ–¼ï¸ ä¸Šå‚³ Logo (å·¦ä¸Šè§’)</label>
            <input type="file" id="logoInput" accept="image/*">
        </div>

        <div class="control-group">
            <label>ğŸ“ Logo å¤§å°èª¿æ•´</label>
            <input type="range" id="logoSize" min="30" max="250" value="80" oninput="updateLogoSize()">
        </div>
        
        <div class="control-group">
            <label>ğŸ“Š é›£åº¦è¨­å®š</label>
            <select id="difficulty">
                <option value="easy">ç°¡å–® (20ä»¥å…§ï¼Œå­—å¤§)</option>
                <option value="medium">ä¸­ç­‰ (å…©ä½æ•¸ï¼Œå­—ä¸­)</option>
                <option value="hard">æŒ‘æˆ° (ç™¾ä½æ•¸/ä¹˜æ³•)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>â•â– é‹ç®—ç¬¦è™Ÿ</label>
            <select id="opType">
                <option value="mixed">æ··åˆ (åŠ ã€æ¸›)</option>
                <option value="add">åªç·´åŠ æ³• (+)</option>
                <option value="sub">åªç·´æ¸›æ³• (-)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>ğŸ§  é¡Œå‹æ¨¡å¼ (èªçŸ¥è¨“ç·´)</label>
            <select id="problemMode">
                <option value="normal">æ¨™æº–è¨ˆç®— (3 + 5 = â–¡)</option>
                <option value="fill">é‚è¼¯å¡«ç©º (3 + â–¡ = 8)</option>
                <option value="mix_mode">æ··åˆæ¨¡å¼ (æ¨™æº– + å¡«ç©º)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>ğŸ“„ ä»½æ•¸ (é )</label>
            <input type="number" id="pageCount" value="1" min="1" max="20">
        </div>
        
        <div class="control-group">
            <label>ğŸ‘€ è§£ç­”ä½ç½®</label>
            <select id="answerMode">
                <option value="next">æ¯é é¡Œç›®å¾Œç·Šæ¥è§£ç­”</option>
                <option value="end">å…¨éƒ¨æœ€å¾Œå½™æ•´è§£ç­”</option>
                <option value="none">ä¸ç”¢ç”Ÿè§£ç­”</option>
            </select>
        </div>
    </div>
    
    <div class="btn-group">
        <button class="gen-btn" onclick="generateSheets()">âœ¨ é‡æ–°ç”Ÿæˆé¡Œç›®</button>
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / é›»è…¦å­˜ PDF</button>
        <button class="pdf-btn" id="pdfBtn" onclick="downloadPDF()">ğŸ“± ä¸‹è¼‰ PDF (æ‰‹æ©Ÿç”¨)</button>
    </div>
</div>

<div class="page-container" id="outputArea">
    <!-- ç”¢å‡ºå…§å®¹æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
</div>

<script>
    // å…¨åŸŸè®Šæ•¸å„²å­˜ Logo è³‡æ–™
    let currentLogoData = null;

    // ç›£è½ Logo ä¸Šå‚³
    document.getElementById('logoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                currentLogoData = event.target.result;
                generateSheets(); // ä¸Šå‚³å¾Œé‡æ–°ç”Ÿæˆä»¥é¡¯ç¤º Logo
            };
            reader.readAsDataURL(file);
        }
    });

    // å³æ™‚æ›´æ–° Logo å¤§å° (ä¸éœ€è¦é‡æ–°ç”Ÿæˆ)
    function updateLogoSize() {
        const size = document.getElementById('logoSize').value;
        const logos = document.querySelectorAll('.sheet-logo');
        logos.forEach(img => {
            img.style.width = size + 'px';
        });
    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function createProblem(difficulty, opType, mode) {
        let n1, n2, ans, symbol;
        let selectedOp = opType;

        if (opType === 'mixed') {
            selectedOp = Math.random() > 0.5 ? 'add' : 'sub';
        }

        if (difficulty === 'hard' && opType === 'mixed' && Math.random() > 0.7) {
            selectedOp = 'mul';
        }

        // --- ç”¢ç”Ÿæ•¸å­—é‚è¼¯ ---
        if (selectedOp === 'mul') {
            n1 = getRandomInt(2, 9);
            n2 = getRandomInt(2, 9);
            ans = n1 * n2;
            symbol = 'Ã—';
        } else if (difficulty === 'easy') {
            if (selectedOp === 'add') {
                n1 = getRandomInt(1, 15);
                n2 = getRandomInt(1, 20 - n1);
                ans = n1 + n2;
                symbol = '+';
            } else {
                n1 = getRandomInt(5, 20);
                n2 = getRandomInt(1, n1);
                ans = n1 - n2;
                symbol = '-';
            }
        } else if (difficulty === 'medium') {
            if (selectedOp === 'add') {
                n1 = getRandomInt(10, 80);
                n2 = getRandomInt(5, 99 - n1);
                ans = n1 + n2;
                symbol = '+';
            } else {
                n1 = getRandomInt(20, 99);
                n2 = getRandomInt(5, n1 - 5);
                ans = n1 - n2;
                symbol = '-';
            }
        } else { // Hard
            if (selectedOp === 'add') {
                n1 = getRandomInt(100, 800);
                n2 = getRandomInt(10, 999 - n1);
                ans = n1 + n2;
                symbol = '+';
            } else {
                n1 = getRandomInt(200, 999);
                n2 = getRandomInt(50, n1 - 10);
                ans = n1 - n2;
                symbol = '-';
            }
        }

        // --- è™•ç†é¡Œå‹é¡¯ç¤º ---
        let displayType = 0; 
        if (mode === 'fill') displayType = 1;
        if (mode === 'mix_mode') displayType = Math.random() > 0.6 ? 1 : 0;

        let html = '';
        let answerVal = '';

        if (displayType === 0) {
            html = `<span class="num">${n1}</span> <span class="operator">${symbol}</span> <span class="num">${n2}</span> <span class="operator">=</span> <div class="answer-box"></div>`;
            answerVal = ans;
        } else {
            html = `<span class="num">${n1}</span> <span class="operator">${symbol}</span> <div class="answer-box"></div> <span class="operator">=</span> <span class="num">${ans}</span>`;
            answerVal = n2;
        }

        return { 
            html: html, 
            ans: answerVal, 
            ansHtml: html.replace('answer-box">', `answer-box answer-filled">${answerVal}`) 
        };
    }

    function generateSheets() {
        const title = document.getElementById('titleInput').value;
        const difficulty = document.getElementById('difficulty').value;
        const opType = document.getElementById('opType').value;
        const problemMode = document.getElementById('problemMode').value;
        const pages = parseInt(document.getElementById('pageCount').value);
        const answerMode = document.getElementById('answerMode').value;
        const logoSize = document.getElementById('logoSize').value;
        const container = document.getElementById('outputArea');
        
        container.innerHTML = ''; 
        let allAnswerSheets = [];

        // --- å›ºå®š 20 é¡Œè¨­å®š ---
        let problemsPerPage = 20; 
        let fontSize = '26pt'; 

        if (difficulty === 'hard') {
            fontSize = '22pt'; 
        }

        for (let i = 1; i <= pages; i++) {
            let problems = [];
            for (let k = 0; k < problemsPerPage; k++) {
                problems.push(createProblem(difficulty, opType, problemMode));
            }

            container.appendChild(createSheetHTML(title, i, pages, problems, false, fontSize, logoSize));

            if (answerMode !== 'none') {
                let ansSheet = createSheetHTML(title + " (è§£ç­”)", i, pages, problems, true, fontSize, logoSize);
                if (answerMode === 'next') container.appendChild(ansSheet);
                else allAnswerSheets.push(ansSheet);
            }
        }

        if (answerMode === 'end') {
            allAnswerSheets.forEach(s => container.appendChild(s));
        }
    }

    function createSheetHTML(title, pageNum, totalPages, problems, isAnswer, fontSize, logoSize) {
        const div = document.createElement('div');
        div.className = 'sheet';
        
        // ç”Ÿæˆ Logo HTML
        let logoHtml = '';
        if (currentLogoData) {
            logoHtml = `<img src="${currentLogoData}" class="sheet-logo" style="width: ${logoSize}px" alt="Logo">`;
        }

        let gridHtml = '';
        problems.forEach(p => {
            gridHtml += `
                <div class="problem-item" style="font-size: ${fontSize}">
                    ${isAnswer ? p.ansHtml : p.html}
                </div>
            `;
        });

        div.innerHTML = `
            ${logoHtml}
            <div class="sheet-header">
                <div class="sheet-title">${title}</div>
                <div class="sheet-info">
                    <span class="info-left">å§“åï¼š____________</span>
                    <span class="info-right">
                        <span>æ—¥æœŸï¼š____ / ____ / ____</span>
                        <span>åˆ†æ•¸ï¼š______</span>
                    </span>
                </div>
            </div>
            <div class="problem-grid">
                ${gridHtml}
            </div>
            <div class="sheet-footer">
                ç¬¬ ${pageNum} é 
            </div>
        `;
        return div;
    }

    // --- æ–°å¢ï¼šè™•ç† PDF ä¸‹è¼‰çš„å‡½å¼ ---
    function downloadPDF() {
        const element = document.getElementById('outputArea');
        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        const title = document.getElementById('titleInput').value;
        
        // è®Šæ›´æŒ‰éˆ•ç‹€æ…‹
        btn.innerText = "â³ è™•ç†ä¸­...è«‹ç¨å€™";
        btn.disabled = true;
        
        // åŠ ä¸Šç‰¹æ®Š class ä»¥ä¿®æ­£è½‰æª”æ™‚çš„æ¨£å¼ (å»é™¤é™°å½±ç­‰)
        document.body.classList.add('generating-pdf');

        const opt = {
            margin:       0, // é‚Šè·è¨­ç‚º0ï¼Œå› ç‚º .sheet å·²ç¶“è¨­å®šå¥½ padding
            filename:     title + '.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true }, // scale: 2 è®“å­—é«”æ›´æ¸…æ™°
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            // pagebreak: { mode: 'css', after: '.sheet' } // ç¢ºä¿æ¯ä¸€å¼µè€ƒå·åˆ†é 
        };

        // åŸ·è¡Œè½‰æ›
        html2pdf().set(opt).from(element).save().then(() => {
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            btn.innerText = originalText;
            btn.disabled = false;
            document.body.classList.remove('generating-pdf');
        }).catch(err => {
            console.error(err);
            alert("è½‰æª”ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ”¹ç”¨ã€Œåˆ—å° -> å­˜æˆ PDFã€åŠŸèƒ½");
            btn.innerText = originalText;
            btn.disabled = false;
            document.body.classList.remove('generating-pdf');
        });
    }

    window.onload = generateSheets;
</script>

</body>
</html>
